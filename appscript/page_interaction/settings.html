<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.js"></script>
</head>
<body>
    <div id="app">
        <h1>Program Settings</h1>
        <textarea style="display: block; margin-bottom:10px;" cols="50" rows="25" v-model="programSettings" placeholder="Adjust program settings here"></textarea>
        <button class="btn btn-primary" @click="saveProgramSettings">Save Settings</button>
        <br>
        <h1>Facebook Settings</h1>
        <label for="page-select">Select a page:</label>
        <select v-model="selected" id="page-select">
            <option v-if="!facebookPages.length" disabled selected="selected">Select a page</option>
            <option v-for="page in selected" v-bind:value="[page]" disabled selected>Selected: {{ page.name }}</option>
            <option v-for="page in facebookPages" v-bind:value="[page]">{{ page.name }}</option>
        </select>
        <button class="btn btn-primary" @click="submitFacebookPageSelection">Update</button>
        <button class="btn btn-danger" @click="removeFacebookPageSelection">Delete</button>
        <div v-if="facebookAuthLink">
            <a target="_blank" id="facebook-auth-link" v-bind:href="facebookAuthLink">
                <img id="facebook-sign-in-button" style="padding-top:10px; width: 200px; display:inline-block; margin:auto;" src="https://storage.googleapis.com/eighth-vehicle-287322.appspot.com/page_interaction_manager/continue-with-facebook.png"></img>
            </a>
        </div>
        <div v-if="JSON.parse(programSettings).hasOwnProperty('experimental')">
            <h1>Profile Link Tool</h1>
            <p>Copy the program input to input file</p>
            <textarea style="display: block; margin-bottom:10px;" v-model="scraperInput"></textarea>
            <p>Copy the program output text file here</p>
            <textarea style="display: block; margin-bottom:10px;" v-model="profileList"></textarea>            
            <button class="btn btn-primary" @click="updateSheetProfileLinks">Submit</button>
        </div>
        <div>
            <h1>Heal Button</h1>
            <p>Use this to try and fix the sheet if it is not working right.</p>
            <button class="btn btn-primary" @click="fireHealFunction">Heal</button>
        </div>
    </div>

      <script>
        new Vue({
            el: '#app',
            data: {
                programSettings: '{}',
                facebookPages:[],
                selected:[],
                scraperInput: '',
                profileList: '',
                facebookAuthLink: undefined,
            },
            methods: {
                saveProgramSettings: function(){
                    google.script.run.withSuccessHandler().saveProgramSettings(JSON.parse(this.programSettings));
                    google.script.run.withSuccessHandler().updateSheet();
                },
                updateProgramSettings: function(settings){
                    // Request settings from google
                    this.programSettings = JSON.stringify(settings, null, 2)
                },
                submitFacebookPageSelection: function(){
                    var pageResults = {'data':this.selected};
                    google.script.run.withSuccessHandler().saveFacebookPagesDetails(pageResults);
                },
                removeFacebookPageSelection: function(){
                    var pageResults = {'data':this.selected};
                    google.script.run.withSuccessHandler().deleteFacebookPagesDetails(pageResults);
                    this.selected = [];
                },
                updateAvailibleFacebookPages: function(pageResults){
                    this.facebookPages = pageResults.data;
                },
                updateSelectedPage: function(selectedPages){
                    this.selected = selectedPages.data;
                },
                updateSheetProfileLinks: function(){
                    var profileList = JSON.parse(this.profileList);
                    google.script.run.withSuccessHandler().updateProfiles(profileList);
                    this.profileList = '';
                },
                updateScraperInput: function(scraperInput){
                    this.scraperInput = JSON.stringify(scraperInput);
                },
                fireHealFunction: function(){
                    google.script.run.withSuccessHandler().healSheet();
                    google.script.run.withSuccessHandler().updateSheet();
                },
                updateFacebookAuthLink: function(facebookAuthLink){
                    this.facebookAuthLink = facebookAuthLink;
                }
            },
            created: function(){
                google.script.run.withSuccessHandler(this.updateProgramSettings).programSettings();
                google.script.run.withSuccessHandler(this.updateAvailibleFacebookPages).getFacebookPages();
                google.script.run.withSuccessHandler(this.updateSelectedPage).getSelectedPages();
                google.script.run.withSuccessHandler(this.updateScraperInput).getScraperInput();
                google.script.run.withSuccessHandler(this.updateFacebookAuthLink).getAuthorizationUrl();

            },
        })
        </script>
</body>

</html>